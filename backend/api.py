from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from backend.core.data_models import QAState, sample_test_compliance
from backend.core.workflow import create_qa_workflow
import uvicorn
import os
from dotenv import load_dotenv

load_dotenv()



app = FastAPI()
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))  # default 8080
    uvicorn.run(app, host="0.0.0.0", port=port)

class RequirementRequest(BaseModel):
    requirement: str
    regulatory_requirements: list[str]

@app.post("/run-workflow")
async def run_workflow(req: RequirementRequest):
    try:
        initial_state = QAState(
            requirement=req.requirement,
            regulatory_requirements=req.regulatory_requirements
        )
        # workflow = create_qa_workflow()
        # final_state = await workflow.ainvoke(initial_state)
        dummy_final_state = sample_test_compliance
        # return dummy_final_state.model_dump()
        return dummy_final_state
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
    
@app.post("/run-local-workflow")
async def run_workflow(req: RequirementRequest):
    try:
        initial_state = QAState(
            requirement=req.requirement,
            regulatory_requirements=req.regulatory_requirements
        )
        workflow = create_qa_workflow()
        final_state = await workflow.ainvoke(initial_state)
        final_state = QAState(**final_state)
        return final_state.model_dump()

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
    
@app.get("/")
async def read_root():
    return {"message": "Welcome to the QA Automation API"}


# "{\"requirement\":\"The system shall provide patients and healthcare providers the ability to book, reschedule, and cancel appointments. Automated reminders must be sent via SMS/email to patients and staff prior to scheduled appointments. The schedule must reflect real-time availability and prevent double-booking of resources (doctors, rooms, equipment).\",\"requirement_analysis\":{\"functional_areas\":{\"modules\":[\"Appointment Management\",\"Resource Scheduling\",\"Notification System\",\"User Management\"],\"workflows\":[\"Appointment Booking (Patient Initiated)\",\"Appointment Booking (Provider/Staff Initiated)\",\"Appointment Rescheduling (Patient Initiated)\",\"Appointment Rescheduling (Provider/Staff Initiated)\",\"Appointment Cancellation (Patient Initiated)\",\"Appointment Cancellation (Provider/Staff Initiated)\",\"Automated Reminder Generation and Delivery\",\"Real-time Availability Check\",\"Resource Allocation and Conflict Resolution\"],\"use_cases\":[\"Book an Appointment as a Patient\",\"Book an Appointment as a Healthcare Provider/Staff\",\"Reschedule an Appointment as a Patient\",\"Reschedule an Appointment as a Healthcare Provider/Staff\",\"Cancel an Appointment as a Patient\",\"Cancel an Appointment as a Healthcare Provider/Staff\",\"Receive an Appointment Reminder (SMS/Email) as a Patient\",\"Receive an Appointment Reminder (SMS/Email) as Staff\",\"View Real-time Schedule Availability\",\"Manage Provider Availability\",\"Manage Room Availability\",\"Manage Equipment Availability\",\"Prevent Double-Booking of Resources\"]},\"security_considerations\":{\"data_protection\":\"All patient and provider data, including appointment details, must be encrypted at rest and in transit (e.g., TLS for web/API, secure protocols for SMS/email gateways). Regular vulnerability assessments and penetration testing should be conducted.\",\"user_authentication\":\"Strong authentication mechanisms (e.g., multi-factor authentication) for both patients and healthcare providers. Password policies should enforce complexity and regular changes.\",\"authorization\":\"Role-based access control (RBAC) to ensure users only access information and functions relevant to their role (e.g., patients can only view/manage their own appointments, providers can view/manage their own schedule and assigned resources).\",\"access_control\":\"Granular access controls based on user roles and specific data entities. Audit trails for all access attempts and data modifications.\",\"logging\":\"Comprehensive logging of all system activities, including user logins, appointment bookings, modifications, cancellations, reminder sends, and any system errors or security events. Logs should be immutable and regularly reviewed.\",\"incident_detection\":\"Monitoring systems to detect unusual activity, unauthorized access attempts, or potential data breaches. Alerting mechanisms should be in place to notify security personnel promptly.\"},\"compliance_requirements\":{\"regulations\":[\"HIPAA (Health Insurance Portability and Accountability Act)\",\"GDPR (General Data Protection Regulation)\",\"PIPEDA (Personal Information Protection and Electronic Documents Act) - if applicable\",\"CCPA (California Consumer Privacy Act) - if applicable\"],\"compliance_measures\":{\"HIPAA\":\"Implementation of administrative, physical, and technical safeguards to protect Protected Health Information (PHI). This includes data encryption, access controls, audit trails, secure communication channels for reminders, and business associate agreements (BAAs) with third-party service providers (e.g., SMS/email gateways).\",\"GDPR\":\"Ensuring data minimization, purpose limitation, data subject rights (right to access, rectification, erasure), consent mechanisms for data processing, data protection impact assessments (DPIAs), and secure processing of personal data, especially for EU citizens.\",\"PIPEDA\":\"Adherence to fair information principles, including consent, limited collection, use, disclosure, accuracy, safeguards, openness, individual access, and accountability for personal information.\",\"CCPA\":\"Providing consumers with the right to know what personal information is collected, the right to delete personal information, and the right to opt-out of the sale of personal information.\"},\"auditability\":\"All actions related to appointments (booking, rescheduling, cancellation), resource allocation, and reminder notifications must be logged with timestamps, user identities, and details of the changes. These logs must be securely stored and readily available for audit purposes to demonstrate compliance with regulatory requirements.\"},\"data_handling\":{\"data_entities\":[\"Patient Records (Name, Contact Information, Appointment History)\",\"Healthcare Provider Records (Name, Specialty, Availability, Contact Information)\",\"Appointment Records (Date, Time, Type, Status, Patient ID, Provider ID, Room ID, Equipment ID)\",\"Resource Records (Rooms, Equipment - Name, Availability, Capacity)\",\"Notification Logs (Recipient, Type, Content, Status, Timestamp)\"],\"data_collection\":\"Data will be collected directly from patients during self-service booking or from healthcare providers/staff during manual booking. Availability data for providers, rooms, and equipment will be managed by staff.\",\"data_storage\":\"Data will be stored in a secure, encrypted database, adhering to industry best practices for data security and regulatory compliance (e.g., HIPAA-compliant cloud storage or on-premise solutions).\",\"data_transmission\":\"All data transmission, including communication between the system and users (web/mobile app), and external services (SMS/email gateways), must be encrypted using strong protocols (e.g., TLS 1.2+).\",\"retention_policy\":\"Data retention policies will be defined based on legal and regulatory requirements (e.g., HIPAA, state medical record retention laws). Patient and appointment data will be retained for the minimum required period and securely archived or deleted thereafter.\",\"backup_policy\":\"Regular, automated backups of all critical data will be performed, including full, incremental, and differential backups. Backups will be encrypted and stored in geographically diverse, secure locations, with defined recovery point objectives (RPO) and recovery time objectives (RTO).\",\"deletion_policy\":\"Data deletion will follow secure erasure methods to prevent recovery. Policies will address deletion upon patient request (where legally permissible) and automated deletion of data past its retention period.\"},\"other_critical_aspects\":{\"interoperability\":\"Potential for integration with existing Electronic Health Record (EHR) or Practice Management (PM) systems for patient demographics, provider schedules, and clinical data. Adherence to standards like HL7 FHIR for data exchange.\",\"integration\":\"Integration with SMS gateway providers for sending text message reminders. Integration with email service providers for sending email reminders. Potential integration with calendar systems (e.g., Google Calendar, Outlook Calendar) for provider schedules.\",\"performance\":\"The system must provide fast response times for checking real-time availability and processing appointment bookings, rescheduling, and cancellations, especially during peak usage hours. Automated reminders must be sent reliably and on schedule.\",\"scalability\":\"The system architecture must be scalable to handle a growing number of patients, healthcare providers, appointments, and resources without degradation in performance. This includes scaling database, application servers, and notification services.\",\"usability\":\"Intuitive and user-friendly interfaces for both patients (for booking/managing appointments) and healthcare providers/staff (for managing schedules, resources, and patient appointments). Clear feedback mechanisms and error handling.\",\"monitoring\":\"Continuous monitoring of system health, performance metrics (e.g., response times, error rates), resource utilization, and notification delivery status. Alerting mechanisms for critical issues and proactive problem resolution.\"}},\"regulatory_requirements\":[\"iso\",\"fda\"],\"current_step\":\"compliance_check\",\"messages\":[{\"content\":\"Starting QA automation workflow\",\"additional_kwargs\":{},\"response_metadata\":{},\"type\":\"human\",\"name\":null,\"id\":null},{\"content\":\"Generating test cases\",\"additional_kwargs\":{},\"response_metadata\":{},\"type\":\"human\",\"name\":null,\"id\":null},{\"content\":\"Generated 32 test cases\",\"additional_kwargs\":{},\"response_metadata\":{},\"type\":\"ai\",\"name\":null,\"id\":null}],\"test_cases\":[{\"id\":\"FUNC-AM-001\",\"title\":\"Patient Initiated Appointment Booking - Successful\",\"description\":\"Verify a patient can successfully book an appointment for an available slot with a chosen provider.\",\"preconditions\":[\"Patient account exists and is logged in.\",\"Provider has available slots for the selected date/time.\",\"Required resources (room, equipment) are available if applicable.\"],\"steps\":[\"Patient navigates to the 'Book Appointment' section.\",\"Patient selects a specialty/provider.\",\"Patient selects an available date and time slot.\",\"Patient confirms appointment details.\",\"System displays a confirmation message.\"],\"expected_results\":[\"Appointment is successfully booked and displayed in the patient's appointment history.\",\"Patient receives an immediate booking confirmation (email/SMS).\",\"Provider's schedule reflects the new appointment.\",\"Resource availability is updated.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\"],\"traceability_id\":\"\"},{\"id\":\"FUNC-AM-002\",\"title\":\"Patient Initiated Appointment Booking - Unavailable Slot\",\"description\":\"Verify a patient cannot book an appointment for an already taken or unavailable slot.\",\"preconditions\":[\"Patient account exists and is logged in.\",\"A specific time slot for a provider is already booked or marked as unavailable.\"],\"steps\":[\"Patient navigates to the 'Book Appointment' section.\",\"Patient selects a specialty/provider.\",\"Patient attempts to select an unavailable date and time slot.\",\"Patient attempts to confirm appointment details.\"],\"expected_results\":[\"The unavailable slot is clearly marked as such and cannot be selected.\",\"If selection is attempted, an error message is displayed indicating unavailability.\",\"Appointment is NOT booked.\"],\"priority\":\"Medium\",\"regulatory_tags\":[],\"traceability_id\":\"\"},{\"id\":\"FUNC-AM-003\",\"title\":\"Staff Initiated Appointment Booking - Successful with Resources\",\"description\":\"Verify staff can book an appointment for a patient, specifying provider, room, and equipment.\",\"preconditions\":[\"Staff account exists and is logged in with appropriate permissions.\",\"Patient record exists.\",\"Provider, room, and equipment are available for the selected date/time.\"],\"steps\":[\"Staff navigates to 'Schedule Appointment' section.\",\"Staff searches for and selects a patient.\",\"Staff selects a provider, date, and time.\",\"Staff selects a specific room and equipment required for the appointment.\",\"Staff confirms appointment details.\",\"System displays a confirmation message.\"],\"expected_results\":[\"Appointment is successfully booked and displayed in the patient's and provider's schedule.\",\"Patient receives an immediate booking confirmation (email/SMS).\",\"Room and equipment schedules reflect the new booking.\",\"Resource availability is updated.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\"],\"traceability_id\":\"\"},{\"id\":\"FUNC-AM-004\",\"title\":\"Patient Initiated Appointment Rescheduling - Successful\",\"description\":\"Verify a patient can successfully reschedule their existing appointment to a new available slot.\",\"preconditions\":[\"Patient account exists and is logged in.\",\"Patient has an upcoming appointment.\",\"New desired slot is available.\"],\"steps\":[\"Patient navigates to 'My Appointments'.\",\"Patient selects an upcoming appointment to reschedule.\",\"Patient selects 'Reschedule' option.\",\"Patient chooses a new available date and time slot.\",\"Patient confirms rescheduling.\",\"System displays a confirmation message.\"],\"expected_results\":[\"Appointment is successfully rescheduled.\",\"Patient receives a rescheduling confirmation (email/SMS).\",\"Original slot becomes available.\",\"New slot is marked as booked in provider's schedule and resource schedules.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\"],\"traceability_id\":\"\"},{\"id\":\"FUNC-AM-005\",\"title\":\"Staff Initiated Appointment Rescheduling - Conflict Resolution\",\"description\":\"Verify staff can reschedule a patient's appointment and the system prevents resource conflicts.\",\"preconditions\":[\"Staff account exists and is logged in with appropriate permissions.\",\"Patient has an upcoming appointment.\",\"New desired slot has a resource conflict (e.g., room already booked).\"],\"steps\":[\"Staff navigates to patient's appointment or provider's schedule.\",\"Staff selects an appointment to reschedule.\",\"Staff attempts to choose a new date/time slot where a required resource (room/equipment) is unavailable.\",\"Staff attempts to confirm rescheduling.\"],\"expected_results\":[\"System displays an error message indicating resource conflict.\",\"Staff is prompted to choose an alternative slot or resolve the conflict.\",\"Appointment is NOT rescheduled until conflicts are resolved.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\"],\"traceability_id\":\"\"},{\"id\":\"FUNC-AM-006\",\"title\":\"Patient Initiated Appointment Cancellation - Successful\",\"description\":\"Verify a patient can successfully cancel their upcoming appointment.\",\"preconditions\":[\"Patient account exists and is logged in.\",\"Patient has an upcoming appointment.\"],\"steps\":[\"Patient navigates to 'My Appointments'.\",\"Patient selects an upcoming appointment to cancel.\",\"Patient selects 'Cancel' option.\",\"Patient confirms cancellation.\",\"System displays a confirmation message.\"],\"expected_results\":[\"Appointment is successfully cancelled and removed from patient's active appointments.\",\"Patient receives a cancellation confirmation (email/SMS).\",\"Provider's schedule and resource schedules reflect the slot as available.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\"],\"traceability_id\":\"\"},{\"id\":\"FUNC-AM-007\",\"title\":\"Staff Initiated Appointment Cancellation - Successful\",\"description\":\"Verify staff can successfully cancel a patient's upcoming appointment.\",\"preconditions\":[\"Staff account exists and is logged in with appropriate permissions.\",\"Patient has an upcoming appointment.\"],\"steps\":[\"Staff navigates to patient's appointment or provider's schedule.\",\"Staff selects an appointment to cancel.\",\"Staff selects 'Cancel' option.\",\"Staff confirms cancellation.\",\"System displays a confirmation message.\"],\"expected_results\":[\"Appointment is successfully cancelled.\",\"Patient receives a cancellation confirmation (email/SMS).\",\"Provider's schedule and resource schedules reflect the slot as available.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\"],\"traceability_id\":\"\"},{\"id\":\"FUNC-RS-001\",\"title\":\"Real-time Availability Check - Provider\",\"description\":\"Verify the system accurately displays a provider's real-time availability.\",\"preconditions\":[\"Staff or patient account exists and is logged in.\",\"Provider's schedule has both available and booked slots.\"],\"steps\":[\"User navigates to view a specific provider's schedule/availability.\",\"Observe the displayed time slots.\"],\"expected_results\":[\"Available slots are clearly distinguishable from booked/unavailable slots.\",\"The displayed availability matches the actual current schedule (e.g., after a recent booking/cancellation).\"],\"priority\":\"High\",\"regulatory_tags\":[],\"traceability_id\":\"\"},{\"id\":\"FUNC-RS-002\",\"title\":\"Manage Provider Availability\",\"description\":\"Verify staff can add, modify, and delete a provider's availability.\",\"preconditions\":[\"Staff account exists and is logged in with appropriate permissions.\",\"Provider record exists.\"],\"steps\":[\"Staff navigates to 'Provider Management' or 'Schedule Management'.\",\"Staff selects a provider.\",\"Staff adds a new availability block (date/time).\",\"Staff modifies an existing availability block.\",\"Staff deletes an availability block.\",\"Staff attempts to delete an availability block with existing appointments.\"],\"expected_results\":[\"New availability block is successfully added and reflected in the provider's schedule.\",\"Existing availability block is successfully modified.\",\"Availability block without appointments is successfully deleted.\",\"System prevents deletion of availability blocks with existing appointments or prompts for rescheduling/cancellation.\",\"Changes are immediately reflected in real-time availability checks.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\"],\"traceability_id\":\"\"},{\"id\":\"FUNC-RS-003\",\"title\":\"Prevent Double-Booking of Resources (Provider, Room, Equipment)\",\"description\":\"Verify the system prevents simultaneous booking of the same resource.\",\"preconditions\":[\"Staff account exists and is logged in.\",\"A provider, room, and equipment are available.\"],\"steps\":[\"Staff books an appointment (Appointment A) for Provider X, Room Y, Equipment Z at Time T.\",\"Immediately, Staff attempts to book another appointment (Appointment B) for Provider X at Time T.\",\"Immediately, Staff attempts to book another appointment (Appointment C) for Room Y at Time T.\",\"Immediately, Staff attempts to book another appointment (Appointment D) for Equipment Z at Time T.\"],\"expected_results\":[\"Appointment A is successfully booked.\",\"Appointment B, C, and D are prevented, and an error message indicating resource unavailability is displayed for each attempt.\",\"The system ensures no resource is double-booked.\"],\"priority\":\"High\",\"regulatory_tags\":[],\"traceability_id\":\"\"},{\"id\":\"FUNC-NS-001\",\"title\":\"Automated Reminder Generation and Delivery - SMS\",\"description\":\"Verify an SMS reminder is generated and delivered to the patient before an appointment.\",\"preconditions\":[\"Patient has an upcoming appointment.\",\"Patient has a valid mobile number on file.\",\"SMS reminders are enabled for the patient/system.\",\"Reminder schedule is configured (e.g., 24 hours before appointment).\"],\"steps\":[\"Book an appointment for a patient for a future date/time.\",\"Wait until the configured reminder trigger time (e.g., 24 hours before).\",\"Check the patient's registered mobile device.\"],\"expected_results\":[\"Patient receives an SMS reminder containing relevant appointment details (date, time, provider).\",\"The SMS content does not contain excessive PHI.\",\"Notification log records the successful delivery of the SMS.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\",\"PIPEDA\"],\"traceability_id\":\"\"},{\"id\":\"FUNC-NS-002\",\"title\":\"Automated Reminder Generation and Delivery - Email\",\"description\":\"Verify an email reminder is generated and delivered to the patient before an appointment.\",\"preconditions\":[\"Patient has an upcoming appointment.\",\"Patient has a valid email address on file.\",\"Email reminders are enabled for the patient/system.\",\"Reminder schedule is configured (e.g., 48 hours before appointment).\"],\"steps\":[\"Book an appointment for a patient for a future date/time.\",\"Wait until the configured reminder trigger time (e.g., 48 hours before).\",\"Check the patient's registered email inbox.\"],\"expected_results\":[\"Patient receives an email reminder containing relevant appointment details (date, time, provider).\",\"The email content does not contain excessive PHI.\",\"Notification log records the successful delivery of the email.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\",\"PIPEDA\"],\"traceability_id\":\"\"},{\"id\":\"FUNC-UM-001\",\"title\":\"User Management - Patient Registration\",\"description\":\"Verify a new patient can register for an account.\",\"preconditions\":[],\"steps\":[\"Navigate to the patient registration page.\",\"Enter all required patient information (Name, Contact Info).\",\"Set a password.\",\"Agree to terms and conditions/privacy policy (consent).\",\"Submit registration form.\"],\"expected_results\":[\"Patient account is successfully created.\",\"Patient receives a confirmation email/SMS.\",\"Patient can log in with the new credentials.\",\"Only necessary data fields are collected during registration (data minimization).\"],\"priority\":\"High\",\"regulatory_tags\":[\"GDPR\",\"PIPEDA\",\"CCPA\"],\"traceability_id\":\"\"},{\"id\":\"SEC-DP-001\",\"title\":\"Data Transmission Encryption (TLS)\",\"description\":\"Verify all data transmitted between the client and server is encrypted using TLS 1.2+.\",\"preconditions\":[\"Access to the application via a web browser.\"],\"steps\":[\"Open the application URL in a web browser.\",\"Observe the browser's security indicator (e.g., padlock icon).\",\"Inspect network traffic using browser developer tools during data submission (e.g., login, booking).\"],\"expected_results\":[\"The browser displays a secure connection indicator (e.g., HTTPS with a valid certificate).\",\"Network traffic shows data being transmitted over TLS 1.2 or higher.\",\"No sensitive data is visible in plain text during transmission.\"],\"priority\":\"Critical\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\",\"PIPEDA\",\"CCPA\"],\"traceability_id\":\"\"},{\"id\":\"SEC-UA-001\",\"title\":\"Multi-Factor Authentication (MFA) for Patient Login\",\"description\":\"Verify MFA is enforced and functions correctly for patient logins.\",\"preconditions\":[\"Patient account exists.\",\"MFA is enabled for the patient account (e.g., via SMS or authenticator app).\"],\"steps\":[\"Patient attempts to log in with correct username and password.\",\"System prompts for the second factor (e.g., OTP from SMS/app).\",\"Patient enters the correct second factor.\",\"Patient enters an incorrect second factor.\"],\"expected_results\":[\"Patient is successfully logged in after providing the correct second factor.\",\"Patient is denied access and receives an error message after providing an incorrect second factor.\",\"MFA prompt is clear and user-friendly.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\"],\"traceability_id\":\"\"},{\"id\":\"SEC-UA-002\",\"title\":\"Password Policy Enforcement\",\"description\":\"Verify the system enforces strong password policies during user registration and password changes.\",\"preconditions\":[],\"steps\":[\"Attempt to register a new user with a weak password (e.g., 'password123').\",\"Attempt to register a new user with a password that meets complexity requirements (e.g., 'P@ssw0rd2024!').\",\"Attempt to change an existing user's password to a weak one.\",\"Attempt to change an existing user's password to one that meets complexity requirements.\"],\"expected_results\":[\"System rejects weak passwords and provides clear feedback on complexity requirements.\",\"System accepts strong passwords.\",\"Password complexity requirements (length, special characters, numbers, mixed case) are enforced.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\"],\"traceability_id\":\"\"},{\"id\":\"SEC-AZ-001\",\"title\":\"Role-Based Access Control (RBAC) - Patient Restrictions\",\"description\":\"Verify a patient user can only access and manage their own appointments and data.\",\"preconditions\":[\"Patient A account exists and is logged in.\",\"Patient B account exists with appointments.\"],\"steps\":[\"Patient A attempts to view Patient B's appointment history.\",\"Patient A attempts to modify Patient B's personal information.\",\"Patient A attempts to access provider-specific management features (e.g., managing provider availability).\"],\"expected_results\":[\"Patient A is denied access to Patient B's data and receives an appropriate error/denial message.\",\"Patient A is unable to access any provider or staff management functionalities.\",\"Patient A can only view and manage their own appointments and profile.\"],\"priority\":\"Critical\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\",\"PIPEDA\",\"CCPA\"],\"traceability_id\":\"\"},{\"id\":\"SEC-AZ-002\",\"title\":\"Role-Based Access Control (RBAC) - Provider Restrictions\",\"description\":\"Verify a provider user can only view and manage their own schedule and assigned resources.\",\"preconditions\":[\"Provider A account exists and is logged in.\",\"Provider B account exists with appointments.\"],\"steps\":[\"Provider A attempts to view/modify Provider B's schedule.\",\"Provider A attempts to access system administration features (e.g., user management, system settings).\",\"Provider A attempts to book an appointment for a patient using a different provider's name.\"],\"expected_results\":[\"Provider A is denied access to Provider B's schedule and receives an appropriate error/denial message.\",\"Provider A is unable to access system administration functionalities.\",\"Provider A can only manage their own schedule and resources directly assigned to them.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\"],\"traceability_id\":\"\"},{\"id\":\"SEC-LG-001\",\"title\":\"Comprehensive Logging - Appointment Actions\",\"description\":\"Verify all appointment-related actions (booking, rescheduling, cancellation) are logged with sufficient detail.\",\"preconditions\":[\"Staff or patient account exists and is logged in.\"],\"steps\":[\"Book an appointment.\",\"Reschedule the booked appointment.\",\"Cancel the rescheduled appointment.\",\"Access the system's audit logs (if accessible via blackbox, otherwise assume backend check).\"],\"expected_results\":[\"Audit logs contain entries for booking, rescheduling, and cancellation.\",\"Each log entry includes: timestamp, user identity, type of action, and details of the change (e.g., old vs. new date/time for reschedule).\",\"Logs are immutable and cannot be tampered with via the UI.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\",\"PIPEDA\",\"CCPA\"],\"traceability_id\":\"\"},{\"id\":\"SEC-LG-002\",\"title\":\"Comprehensive Logging - Authentication Events\",\"description\":\"Verify successful and failed login attempts are logged.\",\"preconditions\":[],\"steps\":[\"Attempt a successful login with valid credentials.\",\"Attempt multiple failed logins with invalid credentials.\",\"Access the system's audit logs (if accessible via blackbox, otherwise assume backend check).\"],\"expected_results\":[\"Audit logs contain entries for successful login attempts, including user ID and timestamp.\",\"Audit logs contain entries for failed login attempts, including user ID (if provided), timestamp, and source IP.\",\"Logs are immutable.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\",\"GDPR\"],\"traceability_id\":\"\"},{\"id\":\"COMP-HIPAA-001\",\"title\":\"Secure Communication for Reminders (HIPAA)\",\"description\":\"Verify appointment reminders sent via SMS/Email do not expose excessive PHI.\",\"preconditions\":[\"Patient has an upcoming appointment.\",\"SMS/Email reminders are enabled and configured.\"],\"steps\":[\"Book an appointment for a patient.\",\"Receive the SMS reminder.\",\"Receive the Email reminder.\"],\"expected_results\":[\"SMS reminder contains minimal PHI (e.g., 'Your appointment with Dr. [Provider Name] on [Date] at [Time]').\",\"Email reminder subject line avoids PHI (e.g., 'Appointment Reminder' instead of 'Your Cardiology Appointment').\",\"Email body contains necessary details but avoids sensitive clinical information.\",\"Option to opt-out of reminders is present or clearly communicated.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\"],\"traceability_id\":\"\"},{\"id\":\"COMP-GDPR-001\",\"title\":\"Data Subject Right - Right to Access (GDPR/PIPEDA/CCPA)\",\"description\":\"Verify a patient can request and access their personal data stored by the system.\",\"preconditions\":[\"Patient account exists and is logged in.\",\"Patient has associated appointment history and personal information.\"],\"steps\":[\"Patient navigates to their profile/settings.\",\"Patient locates and uses the 'Request My Data' or 'Download My Data' feature.\",\"Alternatively, patient contacts support to request their data.\"],\"expected_results\":[\"System provides a mechanism for the patient to view or download their personal data in a structured, commonly used, and machine-readable format.\",\"The data provided is comprehensive and accurate, including contact information, appointment history, and any other collected data.\",\"The process is clear and accessible.\"],\"priority\":\"High\",\"regulatory_tags\":[\"GDPR\",\"PIPEDA\",\"CCPA\"],\"traceability_id\":\"\"},{\"id\":\"COMP-GDPR-002\",\"title\":\"Data Subject Right - Right to Rectification (GDPR/PIPEDA/CCPA)\",\"description\":\"Verify a patient can correct inaccuracies in their personal data.\",\"preconditions\":[\"Patient account exists and is logged in.\",\"Patient has personal information stored (e.g., contact details).\"],\"steps\":[\"Patient navigates to their profile/settings.\",\"Patient attempts to update their contact information (e.g., phone number, email address).\",\"Patient saves the changes.\"],\"expected_results\":[\"Patient is able to successfully update their personal information.\",\"The updated information is reflected in their profile and used for future communications.\",\"An audit log entry is created for the data modification.\"],\"priority\":\"High\",\"regulatory_tags\":[\"GDPR\",\"PIPEDA\",\"CCPA\"],\"traceability_id\":\"\"},{\"id\":\"COMP-GDPR-003\",\"title\":\"Data Subject Right - Right to Erasure (GDPR/PIPEDA/CCPA)\",\"description\":\"Verify a patient can request deletion of their personal data, where legally permissible.\",\"preconditions\":[\"Patient account exists and is logged in.\",\"Patient has associated data.\"],\"steps\":[\"Patient navigates to their profile/settings.\",\"Patient locates and uses the 'Delete My Account' or 'Request Data Deletion' feature.\",\"Alternatively, patient contacts support to request data deletion.\",\"If applicable, patient confirms understanding of implications (e.g., loss of history).\"],\"expected_results\":[\"System initiates the process for secure deletion of the patient's personal data.\",\"Confirmation is provided to the patient that their request is being processed or completed.\",\"After deletion, the patient's account is inaccessible, and their personal data is no longer retrievable (within legal retention limits).\",\"An audit log entry is created for the deletion request/action.\"],\"priority\":\"High\",\"regulatory_tags\":[\"GDPR\",\"PIPEDA\",\"CCPA\"],\"traceability_id\":\"\"},{\"id\":\"COMP-GDPR-004\",\"title\":\"Consent Mechanism for Data Processing\",\"description\":\"Verify explicit consent is obtained for data processing during patient registration.\",\"preconditions\":[],\"steps\":[\"Navigate to the patient registration page.\",\"Observe the consent checkboxes/statements related to privacy policy and terms of service.\",\"Attempt to register without providing consent.\",\"Provide consent and complete registration.\"],\"expected_results\":[\"Clear and unambiguous consent checkboxes/statements are present.\",\"Registration is blocked if consent is not provided.\",\"Registration is successful when consent is provided.\",\"Consent status is recorded for the user.\"],\"priority\":\"High\",\"regulatory_tags\":[\"GDPR\",\"PIPEDA\"],\"traceability_id\":\"\"},{\"id\":\"DATA-COL-001\",\"title\":\"Data Minimization in Patient Registration\",\"description\":\"Verify only essential personal information is collected during patient registration.\",\"preconditions\":[],\"steps\":[\"Navigate to the patient registration page.\",\"Review all fields presented for data collection.\"],\"expected_results\":[\"Only fields necessary for appointment booking and identification (e.g., Name, Contact Information) are marked as mandatory.\",\"Optional fields are clearly indicated as such.\",\"No unnecessary sensitive data is requested at this stage.\"],\"priority\":\"Medium\",\"regulatory_tags\":[\"GDPR\",\"PIPEDA\"],\"traceability_id\":\"\"},{\"id\":\"DATA-DEL-001\",\"title\":\"Secure Data Deletion upon Patient Request\",\"description\":\"Verify patient data is securely and permanently deleted from the system upon a valid request.\",\"preconditions\":[\"Patient account exists with associated data (appointments, profile info).\",\"Patient has submitted a data deletion request (e.g., via UI or support ticket).\"],\"steps\":[\"Initiate a data deletion request for a patient.\",\"Attempt to search for the patient's data in the system (e.g., by staff, or by patient attempting to log in).\",\"Verify associated appointment records are either anonymized or deleted, respecting data integrity for other entities (e.g., provider schedules).\"],\"expected_results\":[\"The patient's personal identifiable information (PII) is no longer accessible or retrievable through the system.\",\"The patient's account is deactivated/deleted.\",\"Associated appointment records are handled according to policy (e.g., anonymized, or deleted if no longer required for regulatory compliance).\",\"Confirmation of deletion is provided to the patient.\"],\"priority\":\"High\",\"regulatory_tags\":[\"GDPR\",\"PIPEDA\",\"CCPA\"],\"traceability_id\":\"\"},{\"id\":\"OTHER-INT-001\",\"title\":\"SMS Gateway Integration - Reminder Delivery\",\"description\":\"Verify the system successfully integrates with the SMS gateway to send appointment reminders.\",\"preconditions\":[\"SMS gateway integration is configured and active.\",\"Patient has a valid mobile number and an upcoming appointment.\"],\"steps\":[\"Book an appointment for a patient.\",\"Wait for the scheduled SMS reminder time.\",\"Verify the SMS is received on the patient's mobile device.\",\"Check system logs for SMS delivery status.\"],\"expected_results\":[\"SMS reminder is delivered to the patient's mobile device.\",\"System logs indicate successful transmission and delivery (if gateway provides status).\",\"No errors related to SMS gateway communication are observed.\"],\"priority\":\"High\",\"regulatory_tags\":[],\"traceability_id\":\"\"},{\"id\":\"OTHER-INT-002\",\"title\":\"Email Service Integration - Reminder Delivery\",\"description\":\"Verify the system successfully integrates with the email service provider to send appointment reminders.\",\"preconditions\":[\"Email service integration is configured and active.\",\"Patient has a valid email address and an upcoming appointment.\"],\"steps\":[\"Book an appointment for a patient.\",\"Wait for the scheduled email reminder time.\",\"Verify the email is received in the patient's inbox.\",\"Check system logs for email delivery status.\"],\"expected_results\":[\"Email reminder is delivered to the patient's email inbox.\",\"System logs indicate successful transmission and delivery (if service provides status).\",\"No errors related to email service communication are observed.\"],\"priority\":\"High\",\"regulatory_tags\":[],\"traceability_id\":\"\"},{\"id\":\"OTHER-PERF-001\",\"title\":\"Performance - Real-time Availability Response Time\",\"description\":\"Measure the response time for checking real-time availability under normal load.\",\"preconditions\":[\"System is under normal operational load (simulated or actual).\",\"Access to the availability check interface.\"],\"steps\":[\"Navigate to the 'Book Appointment' section.\",\"Select a provider and date.\",\"Measure the time taken for available slots to load and display.\"],\"expected_results\":[\"Available slots load and display within acceptable performance thresholds (e.g., < 2 seconds).\",\"The system remains responsive during the availability check.\"],\"priority\":\"Medium\",\"regulatory_tags\":[],\"traceability_id\":\"\"},{\"id\":\"OTHER-USAB-001\",\"title\":\"Usability - Patient Appointment Booking Workflow\",\"description\":\"Evaluate the intuitiveness and user-friendliness of the patient-initiated appointment booking workflow.\",\"preconditions\":[\"Patient account exists and is logged in.\"],\"steps\":[\"Perform the entire patient-initiated appointment booking workflow.\",\"Observe ease of navigation, clarity of instructions, and feedback messages.\",\"Attempt to make a common mistake (e.g., selecting a past date).\"],\"expected_results\":[\"The booking process is intuitive and easy to follow for a typical patient user.\",\"Instructions and prompts are clear and understandable.\",\"Error messages are helpful and guide the user to correct issues.\",\"Confirmation messages are clear and reassuring.\"],\"priority\":\"Medium\",\"regulatory_tags\":[],\"traceability_id\":\"\"},{\"id\":\"OTHER-MON-001\",\"title\":\"Monitoring - Notification Delivery Failure Alert\",\"description\":\"Verify the system generates an alert when automated notification delivery fails.\",\"preconditions\":[\"Monitoring system is active and configured to alert on notification failures.\",\"A scenario can be simulated where a notification fails (e.g., invalid email address, SMS gateway error).\"],\"steps\":[\"Book an appointment for a patient with an intentionally invalid email address or phone number.\",\"Wait for the scheduled reminder time.\",\"Monitor the system's alerting mechanism (e.g., check alert dashboard, email inbox of security personnel).\"],\"expected_results\":[\"An alert is triggered and sent to the configured security/operations personnel, indicating a notification delivery failure.\",\"The alert contains sufficient details to identify the failed notification and recipient.\",\"The system logs the notification delivery failure.\"],\"priority\":\"High\",\"regulatory_tags\":[\"HIPAA\"],\"traceability_id\":\"\"}],\"compliance_results\":[],\"errors\":[],\"workflow_complete\":false,\"workflow_id\":\"ae7c5fd1-ee91-470c-b65b-96ef474f5fa7\",\"created_at\":\"2025-09-19T06:55:53.861474\"}"